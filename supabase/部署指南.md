# Supabase SQL é·ç§»éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•å°‡ GigHub å°ˆæ¡ˆçš„ SQL Migration æª”æ¡ˆéƒ¨ç½²è‡³ Supabase é ç«¯è³‡æ–™åº«ã€‚

**å°ˆæ¡ˆè³‡è¨Š**:
- **å°ˆæ¡ˆ ID**: zecsbstjqjqoytwgjyct
- **Migration æª”æ¡ˆæ•¸é‡**: 6 å€‹
- **é è¨ˆåŸ·è¡Œæ™‚é–“**: 5-10 åˆ†é˜

## ğŸš€ éƒ¨ç½²æ–¹æ³•

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬ï¼ˆæ¨è–¦ï¼‰âœ¨

æˆ‘å€‘æä¾›äº†ä¸€å€‹è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬ï¼Œå¯ä»¥ä¸€æ¬¡æ€§åŸ·è¡Œæ‰€æœ‰ migrationã€‚

#### æ­¥é©Ÿ 1: æº–å‚™é€£ç·šè³‡è¨Š

1. ç™»å…¥ Supabase Dashboardï¼š
   ```
   https://supabase.com/dashboard/project/zecsbstjqjqoytwgjyct
   ```

2. å‰å¾€ **Settings** â†’ **Database**

3. æ‰¾åˆ° **Connection String** å€åŸŸï¼Œé¸æ“‡ **Direct Connection**

4. è¤‡è£½é€£ç·šå­—ä¸²ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
   ```
   postgresql://postgres:[YOUR-PASSWORD]@db.zecsbstjqjqoytwgjyct.supabase.co:5432/postgres
   ```
   âš ï¸ æ³¨æ„ï¼šè«‹å°‡ `[YOUR-PASSWORD]` æ›¿æ›ç‚ºå¯¦éš›çš„è³‡æ–™åº«å¯†ç¢¼

#### æ­¥é©Ÿ 2: è¨­å®šç’°å¢ƒè®Šæ•¸

```bash
export DATABASE_URL='postgresql://postgres:[YOUR-PASSWORD]@db.zecsbstjqjqoytwgjyct.supabase.co:5432/postgres'
```

#### æ­¥é©Ÿ 3: åŸ·è¡Œéƒ¨ç½²è…³æœ¬

```bash
cd /path/to/GigHub
./supabase/deploy-migrations.sh
```

è…³æœ¬æœƒè‡ªå‹•ï¼š
- âœ… æª¢æŸ¥ç’°å¢ƒä¾è³´ï¼ˆpsqlï¼‰
- âœ… æ¸¬è©¦è³‡æ–™åº«é€£ç·š
- âœ… ä¾åºåŸ·è¡Œæ‰€æœ‰ migration
- âœ… é¡¯ç¤ºåŸ·è¡Œçµæœèˆ‡éŒ¯èª¤è¨Šæ¯
- âœ… é©—è­‰éƒ¨ç½²çµæœ

---

### æ–¹æ³•äºŒï¼šä½¿ç”¨ Supabase Dashboardï¼ˆæ‰‹å‹•ï¼‰

#### æ­¥é©Ÿ 1: ç™»å…¥ Dashboard

å‰å¾€ï¼šhttps://supabase.com/dashboard/project/zecsbstjqjqoytwgjyct

#### æ­¥é©Ÿ 2: é–‹å•Ÿ SQL Editor

åœ¨å·¦å´é¸å–®é»æ“Š **SQL Editor**

#### æ­¥é©Ÿ 3: ä¾åºåŸ·è¡Œ Migration

**é‡è¦**ï¼šå¿…é ˆæŒ‰ç…§ä»¥ä¸‹é †åºåŸ·è¡Œï¼Œä¸å¯è·³éï¼

##### 3.1 å»ºç«‹ä»»å‹™è¡¨æ ¼

1. é»æ“Š **New Query**
2. è¤‡è£½ `supabase/migrations/20251212_01_create_tasks_table.sql` çš„å…§å®¹
3. è²¼ä¸Šä¸¦åŸ·è¡Œï¼ˆé»æ“Š **Run** æˆ–æŒ‰ `Ctrl+Enter`ï¼‰
4. ç¢ºèªçœ‹åˆ°æˆåŠŸè¨Šæ¯

##### 3.2 å»ºç«‹æ—¥èªŒè¡¨æ ¼

1. å»ºç«‹æ–°æŸ¥è©¢
2. è¤‡è£½ `supabase/migrations/20251212_02_create_logs_table.sql` çš„å…§å®¹
3. åŸ·è¡Œ

##### 3.3 å»ºç«‹ RLS æ”¿ç­–

1. å»ºç«‹æ–°æŸ¥è©¢
2. è¤‡è£½ `supabase/migrations/20251212_03_create_rls_policies.sql` çš„å…§å®¹
3. åŸ·è¡Œ
4. **é‡è¦**ï¼šæ­¤æ­¥é©Ÿæœƒå»ºç«‹å®‰å…¨æ”¿ç­–ï¼Œç¢ºä¿åŸ·è¡ŒæˆåŠŸ

##### 3.4 å»ºç«‹é€šçŸ¥è¡¨æ ¼

1. å»ºç«‹æ–°æŸ¥è©¢
2. è¤‡è£½ `supabase/migrations/20251212_04_create_notifications_table.sql` çš„å…§å®¹
3. åŸ·è¡Œ

##### 3.5 ä»»å‹™æ•¸é‡è¿½è¹¤æ“´å±•

1. å»ºç«‹æ–°æŸ¥è©¢
2. è¤‡è£½ `supabase/migrations/20251212_04_task_quantity_expansion.sql` çš„å…§å®¹
3. åŸ·è¡Œ

##### 3.6 æ•¸é‡è¿½è¹¤ RLS æ”¿ç­–

1. å»ºç«‹æ–°æŸ¥è©¢
2. è¤‡è£½ `supabase/migrations/20251212_05_task_quantity_rls_policies.sql` çš„å…§å®¹
3. åŸ·è¡Œ

---

### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Supabase CLI

#### å‰ç½®è¦æ±‚

```bash
# å®‰è£ Supabase CLI
npm install -g supabase

# ç™»å…¥
supabase login
```

#### é€£çµå°ˆæ¡ˆ

```bash
cd /path/to/GigHub
supabase link --project-ref zecsbstjqjqoytwgjyct
```

#### åŸ·è¡Œ Migration

```bash
# æ–¹æ³• A: æ¨é€æ‰€æœ‰ migrations
supabase db push

# æ–¹æ³• B: é€ä¸€åŸ·è¡Œ
supabase db execute --file supabase/migrations/20251212_01_create_tasks_table.sql
supabase db execute --file supabase/migrations/20251212_02_create_logs_table.sql
supabase db execute --file supabase/migrations/20251212_03_create_rls_policies.sql
supabase db execute --file supabase/migrations/20251212_04_create_notifications_table.sql
supabase db execute --file supabase/migrations/20251212_04_task_quantity_expansion.sql
supabase db execute --file supabase/migrations/20251212_05_task_quantity_rls_policies.sql
```

---

### æ–¹æ³•å››ï¼šä½¿ç”¨ psql ç›´æ¥é€£ç·š

```bash
# è¨­å®šé€£ç·šå­—ä¸²
export DATABASE_URL='postgresql://postgres:[YOUR-PASSWORD]@db.zecsbstjqjqoytwgjyct.supabase.co:5432/postgres'

# ä¾åºåŸ·è¡Œæ¯å€‹ migration
psql "$DATABASE_URL" -f supabase/migrations/20251212_01_create_tasks_table.sql
psql "$DATABASE_URL" -f supabase/migrations/20251212_02_create_logs_table.sql
psql "$DATABASE_URL" -f supabase/migrations/20251212_03_create_rls_policies.sql
psql "$DATABASE_URL" -f supabase/migrations/20251212_04_create_notifications_table.sql
psql "$DATABASE_URL" -f supabase/migrations/20251212_04_task_quantity_expansion.sql
psql "$DATABASE_URL" -f supabase/migrations/20251212_05_task_quantity_rls_policies.sql
```

---

## âœ… é©—è­‰éƒ¨ç½²

éƒ¨ç½²å®Œæˆå¾Œï¼Œè«‹åŸ·è¡Œä»¥ä¸‹ SQL é€²è¡Œé©—è­‰ã€‚

### 1. æª¢æŸ¥è¡¨æ ¼æ˜¯å¦å»ºç«‹

```sql
-- æ‡‰è©²çœ‹åˆ°æ‰€æœ‰è¡¨æ ¼
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

**é æœŸçµæœ**ï¼š
- âœ… tasks
- âœ… logs
- âœ… notifications
- âœ… log_tasks
- âœ… quality_controls
- âœ… task_progress

### 2. æª¢æŸ¥ RLS æ˜¯å¦å•Ÿç”¨

```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY tablename;
```

**é æœŸçµæœ**ï¼šæ‰€æœ‰è¡¨æ ¼çš„ `rowsecurity` éƒ½æ‡‰è©²æ˜¯ `true`

### 3. æª¢æŸ¥ RLS æ”¿ç­–æ•¸é‡

```sql
SELECT tablename, COUNT(*) as policy_count
FROM pg_policies
WHERE schemaname = 'public'
GROUP BY tablename
ORDER BY tablename;
```

**é æœŸçµæœ**ï¼š
- tasks: â‰¥ 5 å€‹æ”¿ç­–
- logs: â‰¥ 6 å€‹æ”¿ç­–
- notifications: â‰¥ 4 å€‹æ”¿ç­–
- log_tasks: â‰¥ 4 å€‹æ”¿ç­–
- quality_controls: â‰¥ 5 å€‹æ”¿ç­–
- task_progress: â‰¥ 2 å€‹æ”¿ç­–

### 4. æª¢æŸ¥ç´¢å¼•

```sql
SELECT 
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;
```

### 5. æª¢æŸ¥è§¸ç™¼å™¨

```sql
SELECT 
    trigger_name,
    event_manipulation,
    event_object_table
FROM information_schema.triggers
WHERE trigger_schema = 'public'
ORDER BY event_object_table, trigger_name;
```

### 6. åŸ·è¡Œ RLS æ¸¬è©¦å‡½å¼

```sql
-- åŸ·è¡Œå…§å»ºçš„æ¸¬è©¦å‡½å¼
SELECT * FROM public.test_rls_policies();
```

**é æœŸçµæœ**ï¼šæ‰€æœ‰æ¸¬è©¦æ‡‰è©²é€šéï¼ˆ`passed = true`ï¼‰

---

## ğŸ“Š è³‡æ–™åº«çµæ§‹æ¦‚è¦½

éƒ¨ç½²å®Œæˆå¾Œï¼Œè³‡æ–™åº«å°‡åŒ…å«ä»¥ä¸‹çµæ§‹ï¼š

```
å…¬é–‹ Schema (public)
â”œâ”€â”€ æ ¸å¿ƒè¡¨æ ¼
â”‚   â”œâ”€â”€ tasks (ä»»å‹™è¡¨æ ¼)
â”‚   â”œâ”€â”€ logs (æ—¥èªŒè¡¨æ ¼)
â”‚   â””â”€â”€ notifications (é€šçŸ¥è¡¨æ ¼)
â”‚
â”œâ”€â”€ é—œè¯è¡¨æ ¼
â”‚   â”œâ”€â”€ log_tasks (ä»»å‹™-æ—¥èªŒé—œè¯)
â”‚   â”œâ”€â”€ quality_controls (å“è³ªç®¡æ§)
â”‚   â””â”€â”€ task_progress (ä»»å‹™é€²åº¦è¨˜éŒ„)
â”‚
â”œâ”€â”€ å®‰å…¨æ©Ÿåˆ¶
â”‚   â”œâ”€â”€ RLS æ”¿ç­–ï¼ˆæ¯å€‹è¡¨æ ¼ï¼‰
â”‚   â””â”€â”€ Helper å‡½å¼
â”‚
â””â”€â”€ æ•ˆèƒ½å„ªåŒ–
    â”œâ”€â”€ ç´¢å¼•ï¼ˆ30+ å€‹ï¼‰
    â””â”€â”€ è§¸ç™¼å™¨ï¼ˆè‡ªå‹•æ›´æ–°æ™‚é–“æˆ³è¨˜ï¼‰
```

---

## ğŸ”’ å®‰å…¨æ€§èªªæ˜

### RLSï¼ˆRow Level Securityï¼‰æ”¿ç­–

æ‰€æœ‰è¡¨æ ¼éƒ½å·²å•Ÿç”¨ RLSï¼Œç¢ºä¿ï¼š

1. **çµ„ç¹”éš”é›¢**ï¼šä½¿ç”¨è€…åªèƒ½å­˜å–è‡ªå·±çµ„ç¹”çš„è³‡æ–™
2. **è§’è‰²æ¬Šé™**ï¼š
   - `admin`ï¼šå®Œæ•´çš„ CRUD æ¬Šé™
   - `member`ï¼šå—é™çš„ CRUD æ¬Šé™
   - `viewer`ï¼šåƒ…è®€å–æ¬Šé™
3. **å‰µå»ºè€…æ¬Šé™**ï¼šä½¿ç”¨è€…å¯ä»¥ç·¨è¼¯è‡ªå·±å»ºç«‹çš„è³‡æ–™
4. **è»Ÿåˆªé™¤**ï¼šå·²åˆªé™¤çš„è³‡æ–™åªæœ‰ç®¡ç†å“¡å¯è¦‹

### JWT Claims è¦æ±‚

æ‡‰ç”¨ç¨‹å¼éœ€è¦åœ¨ JWT token ä¸­åŒ…å«ä»¥ä¸‹ claimsï¼š

```json
{
  "sub": "user-uuid",              // ä½¿ç”¨è€… ID
  "organization_id": "org-uuid",   // çµ„ç¹” ID
  "role": "admin"                  // è§’è‰²ï¼šadmin, member, viewer
}
```

**è¨­å®šæ–¹å¼**ï¼šåœ¨ Firebase Auth ä¸­é…ç½® Custom Claims

---

## ğŸ› å¸¸è¦‹å•é¡Œæ’è§£

### å•é¡Œ 1ï¼šé€£ç·šå¤±æ•—

**ç—‡ç‹€**ï¼šç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªé€£ç·šå­—ä¸²æ­£ç¢º
2. æª¢æŸ¥å¯†ç¢¼æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—å…ƒï¼ˆéœ€è¦ URL encodeï¼‰
3. ç¢ºèªç¶²è·¯å¯ä»¥é€£æ¥åˆ° Supabase
4. æª¢æŸ¥ IP æ˜¯å¦åœ¨å…è¨±æ¸…å–®ä¸­ï¼ˆå¦‚æœ‰è¨­å®šï¼‰

### å•é¡Œ 2ï¼šMigration åŸ·è¡Œå¤±æ•—

**ç—‡ç‹€**ï¼šSQL åŸ·è¡Œæ™‚å‡ºç¾éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æª¢æŸ¥æ˜¯å¦æŒ‰ç…§é †åºåŸ·è¡Œ
2. ç¢ºèªå‰ä¸€å€‹ migration æ˜¯å¦æˆåŠŸ
3. æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯çš„è©³ç´°å…§å®¹
4. æª¢æŸ¥ Supabase Dashboard çš„ Logs

### å•é¡Œ 3ï¼šRLS æ”¿ç­–ç„¡æ³•å»ºç«‹

**ç—‡ç‹€**ï¼šå‡ºç¾ "relation does not exist" éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª blueprints è¡¨æ ¼å­˜åœ¨ï¼ˆRLS æ”¿ç­–éœ€è¦ï¼‰
2. å¦‚æœ blueprints è¡¨æ ¼ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆå»ºç«‹
3. æˆ–æš«æ™‚è¨»è§£æ‰ä¾è³´ blueprints çš„æ”¿ç­–

### å•é¡Œ 4ï¼šæ¬Šé™ä¸è¶³

**ç—‡ç‹€**ï¼šå‡ºç¾ "permission denied" éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªä½¿ç”¨çš„æ˜¯ service role æˆ– postgres ä½¿ç”¨è€…
2. åœ¨ Supabase Dashboard ä½¿ç”¨ SQL Editor åŸ·è¡Œ
3. ä¸è¦ä½¿ç”¨ anon key åŸ·è¡Œ migration

---

## ğŸ“ éƒ¨ç½²å¾Œæª¢æŸ¥æ¸…å–®

- [ ] æ‰€æœ‰ 6 å€‹ migration æª”æ¡ˆéƒ½å·²åŸ·è¡Œ
- [ ] 6 å€‹è¡¨æ ¼æˆåŠŸå»ºç«‹ï¼ˆtasks, logs, notifications, log_tasks, quality_controls, task_progressï¼‰
- [ ] æ‰€æœ‰è¡¨æ ¼éƒ½å•Ÿç”¨äº† RLS
- [ ] RLS æ”¿ç­–æ•¸é‡æ­£ç¢º
- [ ] æ‰€æœ‰ç´¢å¼•éƒ½å·²å»ºç«‹
- [ ] è§¸ç™¼å™¨æ­£å¸¸é‹ä½œ
- [ ] Helper å‡½å¼å¯ä»¥ä½¿ç”¨
- [ ] æ¸¬è©¦å‡½å¼åŸ·è¡ŒæˆåŠŸ
- [ ] JWT Claims å·²åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­é…ç½®
- [ ] æ‡‰ç”¨ç¨‹å¼å¯ä»¥æ­£å¸¸å­˜å–è³‡æ–™åº«

---

## ğŸ”„ å›æ»¾ï¼ˆRollbackï¼‰

å¦‚æœéœ€è¦å›æ»¾æ‰€æœ‰æ›´æ”¹ï¼š

```sql
-- âš ï¸ è­¦å‘Šï¼šé€™æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼

-- åˆªé™¤è¡¨æ ¼
DROP TABLE IF EXISTS public.task_progress CASCADE;
DROP TABLE IF EXISTS public.quality_controls CASCADE;
DROP TABLE IF EXISTS public.log_tasks CASCADE;
DROP TABLE IF EXISTS public.notifications CASCADE;
DROP TABLE IF EXISTS public.logs CASCADE;
DROP TABLE IF EXISTS public.tasks CASCADE;

-- åˆªé™¤å‡½å¼
DROP FUNCTION IF EXISTS public.test_rls_policies();
DROP FUNCTION IF EXISTS public.is_blueprint_in_user_organization(UUID);
DROP FUNCTION IF EXISTS public.get_user_role();
DROP FUNCTION IF EXISTS public.get_user_id();
DROP FUNCTION IF EXISTS public.get_user_organization_id();
DROP FUNCTION IF EXISTS public.update_updated_at_column();
DROP FUNCTION IF EXISTS public.calculate_task_completed_quantity(UUID);
DROP FUNCTION IF EXISTS public.update_task_completed_quantity();
DROP FUNCTION IF EXISTS public.user_can_access_blueprint(UUID);
DROP FUNCTION IF EXISTS public.user_is_qc_inspector();
DROP FUNCTION IF EXISTS public.user_is_admin();
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [Supabase Migration è©³ç´°èªªæ˜](./migrations/README.md)
- [Supabase æ•´åˆæ¶æ§‹](../docs/architecture/supabase-integration.md)
- [Supabase è¨­å®šæŒ‡å—](../docs/operations/supabase-setup-guide.md)

---

## ğŸ“ æ”¯æ´

å¦‚é‡åˆ°å•é¡Œï¼š

1. ğŸ“‹ æª¢æŸ¥ Supabase Dashboard â†’ Logs
2. ğŸ” æŸ¥çœ‹ SQL Editor çš„éŒ¯èª¤è¨Šæ¯
3. ğŸ“– åƒè€ƒ [Supabase å®˜æ–¹æ–‡æª”](https://supabase.com/docs)
4. ğŸ’¬ è¯çµ¡é–‹ç™¼åœ˜éšŠ

---

## âœ¨ ä¸‹ä¸€æ­¥

éƒ¨ç½²å®Œæˆå¾Œï¼š

1. **æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼**
   - ç¢ºèªå¯ä»¥å»ºç«‹ã€è®€å–ã€æ›´æ–°ã€åˆªé™¤è³‡æ–™
   - æ¸¬è©¦ä¸åŒè§’è‰²çš„æ¬Šé™

2. **é…ç½® Firebase Auth**
   - è¨­å®š Custom Claimsï¼ˆorganization_id, roleï¼‰
   - æ›´æ–° Auth æµç¨‹

3. **æ›´æ–°å‰ç«¯ç¨‹å¼ç¢¼**
   - ä½¿ç”¨æ–°çš„è³‡æ–™è¡¨çµæ§‹
   - å¯¦ä½œæ•¸é‡è¿½è¹¤åŠŸèƒ½
   - æ•´åˆé€šçŸ¥ç³»çµ±

4. **æ•ˆèƒ½ç›£æ§**
   - ç›£æ§æŸ¥è©¢æ•ˆèƒ½
   - æª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³
   - å„ªåŒ–æ…¢æŸ¥è©¢

---

**éƒ¨ç½²æ—¥æœŸ**: 2025-12-12  
**ç¶­è­·è€…**: GigHub Development Team  
**ç‰ˆæœ¬**: 1.0.0
