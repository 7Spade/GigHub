name: Supabase Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      dry_run:
        description: 'Dry run (preview changes without applying)'
        required: false
        type: boolean
        default: false

  push:
    branches:
      - main
      - develop
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/supabase-migrations.yml'

permissions:
  contents: read
  pull-requests: write

env:
  SUPABASE_CLI_VERSION: 2.66.0

jobs:
  validate:
    name: Validate Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
          supabase --version
      
      - name: Validate migration files
        run: |
          echo "Checking migration files..."
          if [ ! -d "supabase/migrations" ]; then
            echo "Error: supabase/migrations directory not found"
            exit 1
          fi
          
          migration_count=$(ls -1 supabase/migrations/*.sql 2>/dev/null | wc -l)
          if [ $migration_count -eq 0 ]; then
            echo "Error: No migration files found"
            exit 1
          fi
          
          echo "âœ… Found $migration_count migration files"
          ls -1 supabase/migrations/*.sql

  migrate-development:
    name: Migrate to Development
    needs: validate
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    environment:
      name: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
      
      - name: Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_DEV }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Run Migrations
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” Running in dry-run mode"
            supabase db push --dry-run
          else
            echo "ðŸš€ Applying migrations"
            supabase db push
          fi
      
      - name: Verify Migrations
        run: |
          echo "Verifying migrations..."
          supabase db execute "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('tasks', 'logs');"

  migrate-staging:
    name: Migrate to Staging
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
      
      - name: Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Run Migrations
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” Running in dry-run mode"
            supabase db push --dry-run
          else
            echo "ðŸš€ Applying migrations"
            supabase db push
          fi

  migrate-production:
    name: Migrate to Production
    needs: validate
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v${{ env.SUPABASE_CLI_VERSION }}/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
      
      - name: Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Create Backup
        run: |
          echo "ðŸ“¦ Creating database backup before migration"
          supabase db dump --db-url ${{ secrets.SUPABASE_DB_URL_PROD }} > backup_$(date +%Y%m%d_%H%M%S).sql
      
      - name: Run Migrations
        run: |
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ðŸ” Running in dry-run mode"
            supabase db push --dry-run
          else
            echo "ðŸš€ Applying migrations to PRODUCTION"
            echo "âš ï¸  This action is irreversible!"
            supabase db push
          fi
      
      - name: Verify Migrations
        run: |
          echo "âœ… Verifying migrations..."
          supabase db execute "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('tasks', 'logs');"
      
      - name: Upload Backup
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backup_*.sql
          retention-days: 30
      
      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Production migration completed successfully"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Production migration failed!"
          echo "Please check logs and restore from backup if necessary"

  notify:
    name: Notify Results
    needs: [migrate-development, migrate-staging, migrate-production]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸŽ¯ Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job results for details." >> $GITHUB_STEP_SUMMARY
